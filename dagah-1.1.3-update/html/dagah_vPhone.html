<?php
    require_once './php/db_creds.php';
    // check for existing session
    session_start();
    if (isset($_SESSION['userid'])) {
        $connection = mysqli_connect($db_hostname, $db_username, $db_password, $db_database);
        // get phone groups
        $userID = $_SESSION['userid'];
        $stmt = mysqli_stmt_init($connection);
        mysqli_stmt_prepare($stmt, 'SELECT DISTINCT PhoneGroup FROM phonebook WHERE UserID=? ORDER BY PhoneGroup ASC');
        mysqli_stmt_bind_param($stmt,'i',$userID);
        mysqli_stmt_execute($stmt);
        mysqli_stmt_store_result($stmt);
        mysqli_stmt_bind_result($stmt, $phoneGroup);

    } else {
        // no session data-- send back to login
        header('Location:  login.html');
    }
    
    // check for file upload
    $message = "";
    if (isset($_SESSION['message'])) {
        $message = $_SESSION['message'];
        unset($_SESSION['message']);
    }
?>

<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Dagah</title>

    <!-- Bootstrap Core CSS -->
    <link href="./components/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet" type="text/css">

    <!-- MetisMenu CSS -->
    <link href="./components/metisMenu/dist/metisMenu.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link href="./css/Dagah.css" rel="stylesheet">
    <link href="./css/Dagah_custom.css" rel="stylesheet">

    <!-- Custom Fonts -->
    <link href="./components/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- jQuery -->
    <script src="./components/jquery/dist/jquery.min.js"></script>

    <!-- Bootstrap Core JavaScript -->
    <script src="./components/bootstrap/dist/js/bootstrap.min.js"></script>

    <!-- Metis Menu Plugin JavaScript -->
    <script src="./components/metisMenu/dist/metisMenu.min.js"></script>

    <!-- Custom Theme JavaScript -->
    <script src="./js/sb-admin-2.js"></script>
    
    <script type="text/javascript">
    
        var phoneGroupFileDisabled = false;
        var phoneGroupAreaDisabled = false;
        
        function disableFile(disable) {

            $('#fileToUpload').prop('disabled', disable);
            if (disable) {
            
                $('#fileToUploadLabel').addClass('disabled-label');
            } else {
                
                $('#fileToUploadLabel').removeClass('disabled-label');
            }
        }
        function setFileDisabled(disable) {
            
            phoneGroupFileDisabled = disable;
            disableFile(disable);
        }
        
        function disableArea(disable) {

            $('#phoneGroupArea').prop('disabled', disable);
            $('.inputs *').prop('disabled', disable);
            if (disable) {
            
                $('#phoneGroupAreaLabel').addClass('disabled-label');
                $('.inputs label').addClass('disabled-label');
                $('.inputs input[type="button"]').addClass('disabled-label');
            } else {
                
                $('#phoneGroupAreaLabel').removeClass('disabled-label');
                $('.inputs label').removeClass('disabled-label');
                $('.inputs input[type="button"]').removeClass('disabled-label');
            }
        }
        function setAreaDisabled(disable) {
            
            phoneGroupAreaDisabled = disable;
            disableArea(disable);
        }
        
        $(document).on({
            'mouseenter'    : function () {
                
                disableFile(false);
            },
            'mouseleave'    : function () {
                
                disableFile(phoneGroupFileDisabled)
            },
            'focus'         : function () {
                
                setFileDisabled(false);
                setAreaDisabled(true);
            },
            'change'        : function () {
                
                setFileDisabled(false);
                setAreaDisabled(true);
            },
        }, '#fileToUpload');
        $(document).on({
            'mouseenter'    : function () {
                
                disableArea(false);
            },
            'mouseleave'    : function () {
                
                disableArea(phoneGroupAreaDisabled);
            },
            'focus'         : function () {
                
                setAreaDisabled(false);
                setFileDisabled(true);
            },
            'input'        : function () {

                setAreaDisabled(false);
                setFileDisabled(true);
            },
        }, '.inputs');
        
        $(document).on({
            'click'         : function () {
                
                var number  = $('#areaToUploadNumber');
                var label   = $('#areaToUploadLabel');
                
                var numberVal = number.val();
                var labelVal = label.val();
                
                var pattern = /[^A-Za-z0-9 \/\_.\-\\\\]/;
                var valid = true;
                
                if (!labelVal) {
                    
                    label[0].setCustomValidity('Please enter field data');
                    label[0].reportValidity();
                    valid = false;
                }
                if (labelVal.match(pattern)) {
                    
                    label[0].setCustomValidity('Wrong field format');
                    label[0].reportValidity();
                    valid = false;
                }
            
                if (!numberVal) {
                    
                    number[0].setCustomValidity('Please enter field data');
                    number[0].reportValidity();
                    valid = false;
                }
                if (numberVal.match(pattern)) {
                    
                    number[0].setCustomValidity('Wrong field format');
                    number[0].reportValidity();
                    valid = false;
                }
                
                if (valid) {

                    // add to textarea
                    value = $('#phoneGroupArea').val();
                    $('#phoneGroupArea').val((value ? value + "\n" : '') + numberVal + ', ' + labelVal);
                    
                    // set fields empty
                    number.val('');
                    label.val('');
                }
            }
        }, '#add_number');
        
    </script>
    <style>
        .disabled-label {
            color: darkgrey;
        }
    </style>
</head>

<body>

    <div id="wrapper">
        <!-- Load Navigation -->
        <?php include('dagah_nav.html'); ?>
		
        <!-- Page Content -->
        <div id="page-wrapper">
           <div class="container-fluid">
            <h2><i class="fa fa-phone fa-fw"></i> Targets</h2>
            <div class="row">
                <!-- /.col-lg-6 -->
                <div class="col-lg-6">
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            Current Target Directory
                        </div>
                        <!-- /.panel-heading -->
                        <div class="panel-body">
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Target Group Name</th>
                                            <th>Show Targets</th>
                                            <th></th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                    <?php
                                    while(mysqli_stmt_fetch($stmt)) {
                                ?>
                                        <tr>
                                            <td><?php echo $phoneGroup ?></td>
                                            <td><button data-target="#<?php echo str_replace(' ','_',$phoneGroup) ?>" data-toggle="modal" class="btn btn-primary btn-xs">View Phone Numbers</button></td>
                                            <td><a href="dagah_DeletePhone.html?id=<?php echo $phoneGroup ?>"><div class="fa fa-trash-o"></div></a></td>
                                            <td style="width: 0px;">
                                                <div aria-hidden="true" aria-labelledby="myModalLabel" role="dialog" tabindex="-1" id="<?php echo str_replace(' ','_',$phoneGroup) ?>" class="modal fade">
                                                    <div class="modal-dialog">
                                                        <div class="modal-content">
                                                            <div class="modal-header">
                                                                <button aria-hidden="true" data-dismiss="modal" class="close" type="button">x</button>
                                                                <h4 id="myModalLabel" class="modal-title"><?php echo $phoneGroup ?></h4>
                                                            </div>
                                                            <div class="modal-body">
                                                                <?php 
                                                                    // query to get phone numbers
                                                                    $stmt_phone = mysqli_stmt_init($connection);
                                                                    mysqli_stmt_prepare($stmt_phone, 'SELECT Name, Number FROM phonebook WHERE PhoneGroup = ?');
                                                                    mysqli_stmt_bind_param($stmt_phone,'s',$phoneGroup);
                                                                    mysqli_stmt_execute($stmt_phone);
                                                                    mysqli_stmt_store_result($stmt_phone);
                                                                    mysqli_stmt_bind_result($stmt_phone, $phoneName, $phoneNum);
                                                                    while(mysqli_stmt_fetch($stmt_phone)) {
                                                                         echo $phoneName . ' ' . $phoneNum . "<br />";
                                                                    }

                                                                ?>
                                                            </div>
                                                        </div>
                                                        <!-- /.modal-content -->
                                                    </div>
                                                    <!-- /.modal-dialog -->
                                                </div>
                                            </td>
                                            
                                        </tr>
                                <?php } ?>

                                       
                                    </tbody>
                                </table>
                            </div>
                            <!-- /.table-responsive -->
                        </div>
                        <!-- /.panel-body -->
                    </div>
                    <!-- /.panel -->
                </div>
                <!-- /.col-lg-6 -->
                <div class="col-lg-6">
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            Create New Target Group
                        </div>
                        <div class="panel-body">
                            <form role="form" action="./php/upload.php" method="post" enctype="multipart/form-data" id="form-upload">
                                <div class="form-group">
                                    <input class="form-control" placeholder="Target Group" title="alphanumeric no spaces" type="text" name="phoneGroup" id="phoneGroup" pattern="[a-zA-Z0-9]+" required="required">
                                </div>
                                <label class="disabled" for="phoneGroupArea" id="phoneGroupAreaLabel">Enter numbers:</label></br>
                                <div class="form-group">
                                    <textarea onkeydown="return false;" class="form-control" rows="5" placeholder="Add numbers here through fields below" title="alphanumeric no spaces" name="phoneGroupArea" id="phoneGroupArea" required="required"></textarea>
                                </div>
                                <div class="form-group inputs">
                                    <label for="areaToUploadNumber" id="areaToUploadNumberLabel">Number: </label>
                                    <input type="text" class="form-control" style="display:inline;width:25%;"name="areaToUploadNumber" id="areaToUploadNumber">
                                    <label for="areaToUploadLabel" id="areaToUploadNumberLabel">Label: </label>
                                    <input type="text" class="form-control" style="display:inline;width:25%;" name="areaToUploadLabel" id="areaToUploadLabel">
                                    <input type="button" class="btn btn-primary" value="Add" id="add_number"/>
                                </div>
                                <label for="fileToUpload" id="fileToUploadLabel">or select a file</label></br>
                                <input type="file" name="fileToUpload" id="fileToUpload"><br />
                                <input type="hidden" name="useFile" id="useFile" value="0"><br />
                                <input type="submit" class="btn btn-block btn-primary" name="submit" value="Upload">
                                <br /><?php echo $message ?>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
           </div>
        </div>
        <!-- /#page-wrapper -->

    </div>
    <!-- /#wrapper -->



</body>
</html>
