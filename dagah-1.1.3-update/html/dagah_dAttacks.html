<?php
    require_once './php/db_creds.php';
    session_start();

	//const $templatesDir = '../templates_processed';
	$templatesDir = $_SESSION['dagah_dir'] . DIRECTORY_SEPARATOR . 'templates';
	
	function parseDirecory($path) {
		
		$result = [];
		
		if ($handle = opendir($path)) {

			while (false !== ($entry = readdir($handle))) {

				if ($entry != "." && $entry != "..") {

					$result[] = $entry;
				}
			}

			closedir($handle);
		}
		
		return $result;
	}
	
    if (!isset($_SESSION['userid'])) {
		
		// no session so send to index
        header('Location:  index.html');
	}
        
	// good login... proceed
	$userID = $_SESSION['userid'];

	
	// check if we're editing the existent attack or adding a new one
	if (empty($_GET['id'])) {
		
		$newAttack = true;
	} else {
		
		$newAttack = false;
		$id = $_GET['id'];
	}
	
	// give back the harvester template

	if (!empty($_POST['getTemplate']) && !empty($_POST['template'])) {

		$path = $templatesDir . DIRECTORY_SEPARATOR . $_POST['template'];
		if (file_exists($path)) {

			$filesContent = [];
			$options = parseDirecory($path);
			foreach ($options as $option) {

				$filesContent[$option] = file_get_contents($path . DIRECTORY_SEPARATOR . $option);
			}
			$result = ['status' => 'ok', 'content' => $filesContent];

		} else {

			$result = ['status' => 'error', 'content' => 'Wrong template name.'];
		}

		header('Content-type: application/json');
		echo json_encode($result);
		exit;
	} elseif (!empty($_POST['saveTemplate']) && !empty($_POST['name']) && !empty($_POST['pages'])) {

		$path	= $templatesDir . DIRECTORY_SEPARATOR . $_POST['name'];
		$pages	= $_POST['pages'];
		if (file_exists($path) && is_array($pages)) {

			$filesContent = [];
			$options = parseDirecory($path);
			foreach ($pages as $pageName => $pageContent) {

				if (file_exists($path . DIRECTORY_SEPARATOR . $pageName)) {

					@file_put_contents($path . DIRECTORY_SEPARATOR . $pageName, $pageContent);
				}

				$result = ['status' => 'ok'];
			}


		} else {

			$result = ['status' => 'error', 'content' => 'Wrong template name or data.'];
		}

		header('Content-type: application/json');
		echo json_encode($result);
		exit;
	}

	// check to see if attack alrady saved
	$connection = mysqli_connect($db_hostname, $db_username, $db_password, $db_database);
	$label_error = "";
	$message = "";

	// sms templates 
	$sql = 'SELECT sms_templates.text FROM sms_templates WHERE userId = ' . (int) $_SESSION['userid'];
	$query = mysqli_query($connection, $sql);
	$smsOptions = [];
	while ($reslt = $query->fetch_assoc()) {

		$smsOptions[] = $reslt['text'];
	}

	if (count($_POST) > 0) {
		$fail = false;
		// Check variables for command injection
		$characterpattern = '/[^A-Za-z0-9\,\!\_ \.\-\\\\]/';
		$patternnospace = '/[^A-Za-z0-9\_\.\-\\\\]/';
		$urlpattern = '/[^A-Za-z0-9\_\.\:\/\-\\\\]/';
		$xmlpattern = '/[^A-Za-z0-9\<\>\!\"\= \:\_\/ .\-\\\\]/';
		if (preg_match($patternnospace, $_POST['aAttack_Label'])) {
		   // Someone mucking with Attack
		   $fail = true;
		   $_POST['aAttack_Label'] = "";
		   $label_error = "<div class='alert alert-danger'>Attack Label contains unallowed characters.</div>";
		} else if (preg_match($characterpattern, $_POST['aAttack_Type'])) {
		   // Someone mucking with Attack
		   $fail = true;
		   $_POST['aAttack_Type'] = "";
		   $label_error = "<div class='alert alert-danger'>Attack Type contains unallowed characters.</div>";
		} else if (preg_match($patternnospace, $_POST['aFile_Directory'])) {
		   // Someone mucking with Attack
		   $fail = true;
		   $_POST['aFile_Directory'] = "";
		   $label_error = "<div class='alert alert-danger'>File Directory contains unallowed characters.</div>";
		} else if (preg_match($patternnospace, $_POST['aTarget_Page'])) {
		   // Someone mucking with Attack
		   $fail = true;
		   $_POST['aTarget_Page'] = "";
		   $label_error = "<div class='alert alert-danger'>Target Page contains unallowed characters.</div>";
		} else if (preg_match($characterpattern, $_POST['aDelivery_Method'])) {
		   // Someone mucking with Attack
		   $fail = true;
		   $_POST['aDelivery_Method'] = "";
		   $label_error = "<div class='alert alert-danger'>Delivery Method contains unallowed characters.</div>";
		} else if (preg_match($characterpattern, $_POST['aSMS_Text'])) {
		   // Someone mucking with Attack
		   $fail = true;
		   $_POST['aSMS_Text'] = "";
		   $label_error = "<div class='alert alert-danger'>SMS Text contains unallowed characters.</div>";
		} else if (preg_match($characterpattern, $_POST['amessaging_app'])) {
		   // Someone mucking with Attack
		   $fail = true;
		   $_POST['amessaging_app'] = "";
		   $label_error = "<div class='alert alert-danger'>Messaging App Type contains unallowed characters.</div>";
		} else if (preg_match($characterpattern, $_POST['aWebpage_Text'])) {
		   // Someone mucking with Attack
		   $fail = true;
		   $_POST['aWebpage_Text'] = "";
		   $label_error = "<div class='alert alert-danger'>Webpage Text contains unallowed characters.</div>";
		} else if (preg_match($urlpattern, $_POST['aWebpage_Clone'])) {
		   // Someone mucking with Attack
		   $fail = true;
		   $_POST['aWebpage_Clone'] = "";
		   $label_error = "<div class='alert alert-danger'>Clone Page URL contains unallowed characters.</div>";
		} else if (preg_match($characterpattern, $_POST['aPhishing_Text'])) {
		   // Someone mucking with Attack
		   $fail = true;
		   $_POST['aPhishing_Text'] = "";
		   $label_error = "<div class='alert alert-danger'>SMS Text contains unallowed characters.</div>";
		} else if (preg_match($urlpattern, $_POST['aBackdoor_App'])) {
		   // Someone mucking with Attack
		   $fail = true;
		   $_POST['aBackdoor_App'] = "";
		   $label_error = "<div class='alert alert-danger'>Backdoor App Name contains unallowed characters.</div>";
		} else if (preg_match($urlpattern, $_POST['aProfile'])) {
		   // Someone mucking with Attack
		   $fail = true;
		   $_POST['aProfile'] = "";
		   $label_error = "<div class='alert alert-danger'>Profile File Name contains unallowed characters.</div>";               
		} else if (preg_match($xmlpattern, $_POST['xml'])) {
		   // Someone mucking with Attack
		   $fail = true;
		   $_POST['xml'] = "";
		   $label_error = "<div class='alert alert-danger'>XML contains unallowed characters.</div>";
		}

		// validate that all the right arguments where in place that couldn't be checked in javascript
		// Check that a messaging app was selected if the delivery method = messaging_app
		if ($_POST['aDelivery_Method'] == 'messagingapp') {
			if (!$_POST['amessaging_app']){
			   $fail = true;
			   $label_error = "<div class='alert alert-danger'>Please select an application for messaging app delivery method.</div>";
			}
		}

		// validate check for uniqueness of campaign name and attack label name
		$attackLabel = trim($_POST['aAttack_Label']);
		
		if ($newAttack) {
		
			$stmt = mysqli_stmt_init($connection);
			mysqli_stmt_prepare($stmt, 'SELECT * FROM attacks WHERE LABEL= ?');
			mysqli_stmt_bind_param($stmt, 's', $attackLabel);
			mysqli_stmt_execute($stmt);
			mysqli_stmt_store_result($stmt);

			if (mysqli_stmt_num_rows($stmt) > 0) {
				$fail = true;
				$label_error = "<div class='alert alert-danger'>Attack Label Name is already in use. Please choose another</div>";
			}
		}

		if (!$fail) {
			$error = false;
			// passes validation-- save
			// set file directory
			$_POST['aFile_Directory'] = $_POST['aAttack_Label'];
			// save notification
			$Comment = "Attack Created" . " " . $_POST['aAttack_Label'];
			$Type = "campaign";
			$stmt = mysqli_stmt_init($connection);
			mysqli_stmt_prepare($stmt, 'INSERT INTO notifications (Comment, Time, Type, UserID) VALUES (?,(now() - interval 4 hour),?,?)');
			mysqli_stmt_bind_param($stmt, 'ssi',$Comment,$Type,$userID);
			mysqli_stmt_execute($stmt);
			mysqli_stmt_store_result($stmt);

			if (($_POST['aAttack_Type'] == 'agent') && ($_FILES['aAndroid_Backdoor_Application']['name'] != '')) {
				// an agent attack... save agent app
				// save uploaded files
				$error = false;
				$android_path = $_SESSION['dagah_dir'] . "/android_uploads/" . basename($_FILES['aAndroid_Backdoor_Application']['name']);
				if (!move_uploaded_file($_FILES['aAndroid_Backdoor_Application']['tmp_name'],$android_path)) {
					$error = true;
					$message = "<div class='alert alert-danger'>Error uploading backdoor app: " . $_FILES['aAndroid_Backdoor_Application']['tmp_name'] . " to " . $android_path . "</div>";
				}

			}
			if ($_POST['aAttack_Type'] == 'profile') {
				if ($_FILES['aProfile_File']['name'] != '') {
					// an profile attack... save profile
					// save uploaded files
					$error = false;
					$profile_path = $_SESSION['dagah_dir'] . $_SESSION['profiles_dir'] . basename($_FILES['aProfile_File']['name']);
					if (!move_uploaded_file($_FILES['aProfile_File']['tmp_name'],$profile_path)) {
						$error = true;
						$message = "<div class='alert alert-danger'>Error uploading profile: " . $_FILES['aProfile_File']['tmp_name'] . " to " . $profile_path . "</div>";
					}
				} else {
					$error = true;
					$message = "<div class='alert alert-danger'>Please upload a .mobileconfig file for Profile Attacks.</div>";
				}

			}

			// harvester template
			if ($_POST['aAttack_Type'] == 'harvester') {

				if (!empty($_POST['aHarvester_Template_Name'])) {

					if (!file_exists($templatesDir . DIRECTORY_SEPARATOR . $_POST['aHarvester_Template_Name'])) {

						$error = true;
						$message = "<div class='alert alert-danger'>No harvester template with name: \"" . $_POST['aHarvester_Template_Name'] . "\" found.</div>";
					}
					unset($_POST['aWebpage_Clone']);
				}
			} else {

				unset($_POST['aHarvester_Template_Name']);
			}
			
			if (!$error) {

				// save main attack first
				$aAttack_Label = $_POST['aAttack_Label'];
				$Xml = $_POST['xml'];
				$stmt = mysqli_stmt_init($connection);
				if ($newAttack) {

					mysqli_stmt_prepare($stmt, 'INSERT INTO attacks (Label, Created, UserID, XML) VALUES (?, (now() - interval 4 hour), ?, ?)');
					mysqli_stmt_bind_param($stmt, 'sis', $attackLabel, $userID, $Xml);
				} else {

					mysqli_stmt_prepare($stmt, 'UPDATE attacks SET Label = ?, UserID = ?, XML = ? WHERE ID = ?');
					mysqli_stmt_bind_param($stmt, 'sisi', $attackLabel, $userID, $Xml, $id);
				}
				mysqli_stmt_execute($stmt);
				mysqli_stmt_store_result($stmt);
				$attack_id = $newAttack
					? mysqli_stmt_insert_id($stmt)
					: $id; 

				// delete old attributes if editing the existing attack
				if (!$newAttack) {

					$stmt = mysqli_stmt_init($connection);
					mysqli_stmt_prepare($stmt, 'DELETE FROM attack_attributes WHERE AttackID=?');
					mysqli_stmt_bind_param($stmt, 'i', $attack_id);
					mysqli_stmt_execute($stmt); 
				}

				// save attributes
				foreach($_POST as $key => $value)
				{
					if ($key[0] == 'a') {
						// only save $_POST attributes that start with 'a' that are not null
						$key = ltrim($key, 'a');
						if (!empty($value)) {
							if ($key == 'Webpage_Text') {
								$value = htmlspecialchars($value);
							}
							// Add attributes to database
							$stmt = mysqli_stmt_init($connection);
							mysqli_stmt_prepare($stmt, 'INSERT INTO attack_attributes (Attribute, Value, UserID, AttackID) VALUES (?,?,?,?)');
							mysqli_stmt_bind_param($stmt, 'ssii', $key, $value, $userID, $attack_id);
							mysqli_stmt_execute($stmt);

						}
					}
				}


				// save XML
				$stmt = mysqli_stmt_init($connection);
				mysqli_stmt_prepare($stmt, 'INSERT INTO attack_attributes (Attribute, Value, UserID, AttackID) VALUES ("XML", ?, ?, ?)');
				mysqli_stmt_bind_param($stmt, 'sii', $Xml,$userID,$attack_id);
				mysqli_stmt_execute($stmt); 

				// delete all created campaigns for the attack being edited
				if (!$newAttack) {

					// delete binded campaigns' XML files
					$stmt_campaign = mysqli_stmt_init($connection);
					mysqli_stmt_prepare($stmt_campaign, 'SELECT Name FROM campaigns WHERE ID IN (SELECT CampaignID FROM linkcampaignsattacks WHERE AttackID = ?)');
					mysqli_stmt_bind_param($stmt_campaign, 'i', $id);
					mysqli_stmt_execute($stmt_campaign);
					mysqli_stmt_store_result($stmt_campaign);
					mysqli_stmt_bind_result($stmt_campaign, $oldCampaignName);
					while (mysqli_stmt_fetch($stmt_campaign)) {
						
						@unlink($_SESSION['dagah_dir'] . $_SESSION['campaign_dir'] . $oldCampaignName . ".xml");
					}
					
					// delete binded campaigns from DB
					$stmt = mysqli_stmt_init($connection);
					mysqli_stmt_prepare($stmt, 'DELETE FROM campaigns WHERE ID IN (SELECT CampaignID FROM linkcampaignsattacks WHERE AttackID = ?)');
					mysqli_stmt_bind_param($stmt, 'i', $attack_id);
					mysqli_stmt_execute($stmt);

					// delete binded campaigns' links to attacks from DB
					$stmt = mysqli_stmt_init($connection);
					mysqli_stmt_prepare($stmt, 'DELETE FROM linkcampaignsattacks WHERE AttackID = ?');
					mysqli_stmt_bind_param($stmt, 'i', $attack_id);
					mysqli_stmt_execute($stmt);

					$_SESSION['message'] = '<div class="alert alert-success">Attack has been successfully updated.</div>';

					header('Location: dagah_vAttacks.html');
					exit;
				}

        // creating new campaign here
        $result = null;
        if (!empty($_POST['aAutoCreateCampaign'])) {

          $_POST['Campaign_Label']	    	= ltrim($aAttack_Label);
          $_POST['attack_' . $attack_id]	= $attack_id;
          $_POST['submit']			        	= 'Save Campaign';
          $_POST['forceName']			      	= true;
          $_POST['nameSuffix']		      	= '_(automatically_created_' . date('Y/m/d_H-i-s') . ')';

          $returnCampaignSaveResult		= true;
          $result							        = include 'dagah_dCampaigns.html';

          if ($result !== null) {

            $_SESSION['message'] = '<div class="alert alert-danger">' . $result . '</div>';
          }
        }

				header('Location: dagah_home.html');
			}
		}
	}
	
	
		
	$aAttack_Label				= empty($_POST['aAttack_Label']) ? '' : $_POST['aAttack_Label'];
	$aFile_Directory			= empty($_POST['aFile_Directory']) ? '' : $_POST['aFile_Directory'];
	$aTarget_Page				= empty($_POST['aTarget_Page']) ? '' : $_POST['aTarget_Page'];
	$aSMS_Text					= empty($_POST['aSMS_Text']) ? '' : $_POST['aSMS_Text'];
	$messaging_app				= empty($_POST['messaging_app']) ? '' : $_POST['messaging_app'];
	$aWebpage_Text				= empty($_POST['aWebpage_Text']) ? '' : $_POST['aWebpage_Text'];
	$aHarvester_Template_Name	= empty($_POST['aHarvester_Template_Name']) ? '' : $_POST['aHarvester_Template_Name'];
	$aWebpage_Clone				= empty($_POST['aWebpage_Clone']) ? '' : $_POST['aWebpage_Clone'];
	$Delivery_Method			= empty($_POST['Delivery_Method']) ? '' : $_POST['Delivery_Method'];
	$aAttack_Type				= empty($_POST['aAttack_Type']) ? '' : $_POST['aAttack_Type'];
	
	if (!$newAttack) {

		$stmt = mysqli_stmt_init($connection);
		mysqli_stmt_prepare($stmt, 'SELECT ID, Label, UserID, Created, XML FROM attacks WHERE ID = ?');
		mysqli_stmt_bind_param($stmt, 'i', $id);
		mysqli_stmt_execute($stmt);
		mysqli_stmt_store_result($stmt);
		mysqli_stmt_bind_result($stmt, $aId, $aLabel, $aUserId, $aCreated, $aXml);
		mysqli_stmt_fetch($stmt);

		$aAttack_Label				= $aAttack_Label ? $aAttack_Label : $aLabel;
		
		// now get all the attack attributes
		$stmt = mysqli_stmt_init($connection);
		mysqli_stmt_prepare($stmt, 'SELECT Attribute, Value FROM attack_attributes WHERE AttackID = ?');
		mysqli_stmt_bind_param($stmt, 'i', $id);
		mysqli_stmt_execute($stmt);
		mysqli_stmt_store_result($stmt);
		mysqli_stmt_bind_result($stmt, $aaAttribute, $aaValue);
		
		while (mysqli_stmt_fetch($stmt)) {

					

			switch ($aaAttribute) {
				
				case 'File_Directory':
					$aFile_Directory			= $aFile_Directory ? $aFile_Directory : $aaValue;
					break;
				
				case 'Target_Page':
					$aTarget_Page				= $aTarget_Page ? $aTarget_Page : $aaValue;
					break;
				
				case 'SMS_Text':
					$aSMS_Text					= $aSMS_Text ? $aSMS_Text : $aaValue;
					break;
					
				case 'messaging_app':
					$messaging_app				= $messaging_app ? $messaging_app : $aaValue;
					break;
				
				case 'Webpage_Text':
					$aWebpage_Text				= $aWebpage_Text ? $aWebpage_Text : $aaValue;
					break;

				case 'Harvester_Template_Name':
					$aHarvester_Template_Name	= $aHarvester_Template_Name ? $aHarvester_Template_Name : $aaValue;
					break;
				
				case 'Webpage_Clone':
					$aWebpage_Clone				= $aWebpage_Clone ? $aWebpage_Clone : $aaValue;
					break;	
				
				case 'Delivery_Method':
					$Delivery_Method			= $Delivery_Method ? $Delivery_Method : $aaValue;
					break;
				
				case 'Attack_Type':
					$aAttack_Type				= $aAttack_Type ? $aAttack_Type : $aaValue;
					break;
			}
		
		}
	}
	

?> 

<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Design Attacks</title>

    <!-- Bootstrap Core CSS -->
    <link href="./components/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet" type="text/css">

    <!-- MetisMenu CSS -->
    <link href="./components/metisMenu/dist/metisMenu.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link href="./css/Dagah.css" rel="stylesheet">
    <link href="./css/Dagah_custom.css" rel="stylesheet">

    <!-- Custom Fonts -->
    <link href="./components/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

</head>

<body>
    <style>
        .basic {display: none;}
        .harvester {display: none;}
        .agent {display: none;}
        .profile {display: none;}
        .all {display:none;}
        .sms {display:none;}
        .messagingapp {display:none;}
		
		select {height:35px;}
    </style>

    <div id="wrapper">

        <!-- Navigation -->
        <?php include('dagah_nav.html'); ?>
		
        <!-- Page Content -->
        <div id="page-wrapper">
            <div class="container-fluid">
                <?php echo $label_error ?>
                <?php echo $message ?>
                <h2><i class="fa fa-plane fa-fw"></i> <?php if ($newAttack): ?>Design New Attack<?php else: ?> Edit Attack <?php endif;?></h2>
                <div class="row">
                <!-- /.col-lg-6 -->
                <div class="col-lg-12">
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <?php if ($newAttack): ?>Create New Attack<?php endif; ?>
                        </div>
                        <!-- /.panel-heading -->
                        <div class="panel-body">
                            <form id="campaign_form" role="form" method="post" enctype="multipart/form-data">
                                <div class="form-group">
                                    <input id="aAttack_Label" name="aAttack_Label" class="form-control" value="<?php echo $aAttack_Label ?>" title="alphanumeric, no spaces (,!_-\)" required="required" pattern="[a-zA-Z0-9^_-@!%&*()+=\[\]:\?\/]+"/>
                                    <p class="help-block">Unique Attack Label</p>
                                </div>
                                <div class="form-group">
                                    <label>Type of Attack: </label>
                                    <label class="radio-inline">
                                        <input id="attack1" type="radio" value="basic" name="aAttack_Type" required="required"/>
                                        Basic
                                    </label>
                                    <label class="radio-inline">
                                        <input id="attack2" type="radio" value="harvester" name="aAttack_Type" required="required"/>
                                        Harvester
                                    </label>
                                    <label class="radio-inline">
                                        <input id="attack3" type="radio" value="agent" name="aAttack_Type" required="required" <?php if( !$_SESSION['licAgent']) echo "disabled=\"disabled\"" ?> />
                                        Agent (Professional License Only)
                                    </label>
                                    <label class="radio-inline">
                                        <input id="attack4" type="radio" value="profile" name="aAttack_Type" required="required"/>
                                        Profile
                                    </label>
                                    <label class="radio-inline">
                                        <input id="attack5" type="radio" value="client" name="aAttack_Type" required="required" <?php if( !$_SESSION['licClientSide']) echo "disabled=\"disabled\"" ?> />
                                        Client-Side (Enterprise License Only)
                                    </label>
                                </div>
                                <hr class="form-group all" />
                                <div class="form-group all">
                                    <input id="directory" class="form-control" name="aFile_Directory" type="hidden" title="alphanumeric, no spaces (,!_-\)" value="<?php echo $aFile_Directory ?>" required="required" pattern="[a-zA-Z0-9^_-@!%&*()+=\[\]:\?\/]+" disabled="disabled" />
                                    
                                </div>
                                <div class="form-group all">
                                    <input id="targetPage" class="form-control" name="aTarget_Page" type="hidden" value="index.html" title="alphanumeric, no spaces (,!_-\) Must end in .html" required="required" pattern="[a-zA-Z0-9^_-@!%&*()+=\[\]:\?\/]+" />
                                </div>
                                <div class="form-group all">
                                    <label>Delivery Method: </label>
                                    <label class="radio-inline">
                                        <input id="attack6" type="radio" value="sms" name="aDelivery_Method" required="required"/>
                                        SMS
                                    </label>
                                    <label class="radio-inline">
                                        <input id="attack7" type="radio" value="qrc" name="aDelivery_Method" required="required"/>
                                        QR Code
                                    </label>
                                    <label class="radio-inline">
                                        <input id="attack8" type="radio" value="nfc" name="aDelivery_Method" required="required"/>
                                        NFC
                                    </label>
                                    <label class="radio-inline">
                                        <input id="attack9" type="radio" value="messagingapp" name="aDelivery_Method" required="required" <?php if( !$_SESSION['licMsgApp']) echo "disabled=\"disabled\"" ?> />
                                        Messaging Application (Twitter, WhatsApp) (Professional License Only)
                                    </label>
                                    <label class="radio-inline">
                                        <input id="attack10" type="radio" value="external" name="aDelivery_Method" required="required"/>
                                        External
                                    </label>
                                </div>
                                <div class="form-group sms">
                                    <input id="sms_text" class="form-control" name="aSMS_Text" value="<?php echo $aSMS_Text ?>" title="alphanumeric, spaces (,!_-\)" pattern="[^A-Za-z0-9\,\!\_ \.\-\\\\]" />
                                    <p class="help-block">Text to send as message</p>
                                    <select name="smsHint" onchange="selectTemplate(this)">
                                        <option value=""></option>
                                        <?php foreach($smsOptions as $option) echo '<option value="' . $option . '">' . (strlen($option) > 100 ? substr($option, 0, 100) . '...' : $option) . '</option>' ?>
                                    </select>
                                    <p class="help-block">You can also choose a Message template from list</p>
                                </div>
                                <div class="form-group messagingapp">
                                    <label class="radio-inline">
                                        <input id="message_app" type="radio" value="twitter" name="amessaging_app"/>
                                    Twitter
                                    </label>
                                    <label class="radio-inline">
                                        <input id="message_app" type="radio" value="whatsapp" name="amessaging_app"/>
                                    WhatsApp
                                    </label>
                                </div>
                                <div class="form-group basic">
                                    <input id="webpage" class="form-control" name="aWebpage_Text" title="alphanumeric (special allowed) with spaces" value="<?php echo $aWebpage_Text ?>" />
                                    <p class="help-block">Text to appear on the phishing destination webpage</p>
                                </div>
                                <div class="form-group harvester">

								
								<!-- List of templates -->
								<p class="help-block">Chose harvester template:
									<br>
								<select name="template" id="template">
									<option value=""></option>
									<?php
									
									$options = parseDirecory($templatesDir);
									foreach ($options as $option) {
												
										echo '<option value="' . $option . '"'
											. (!empty($aHarvester_Template_Name) && ($option == $aHarvester_Template_Name) ? ' selected="selected" ' : '')
											. '>' . $option . '</option>';
									}
									?>
								</select>
								<input type="hidden" name="aHarvester_Template_Name" id="harvester-template-name" />

								</p>
									
									<p class="help-block">or enter URL:</p>
                                    <input type="url" pattern="https?://.+" id="webpage_clone" class="form-control" name="aWebpage_Clone" title="URI" value="<?php echo $aWebpage_Clone ?>" />
                                    <p class="help-block">URL to login page to clone (e.g. https://gmail.google.com)</p>
                                </div>
                                <div class="form-group agent">
                                    <input id="android_app" name="aAndroid_Backdoor_Application" type="file" />
                                    <p class="help-block">Android Application to backdoor with agent (optional)</p>
                                </div>
                                <div class="form-group profile">
                                    <input id="profile_name" name="aProfile_File" type="file" />
                                    <p class="help-block">Profile (.mobileconfig) file generated by Apple Configurator 2.0</p>
                                </div>
								<div class="form-group">
									<label class="radio-inline" style="padding-left:0px;">
                                        <input type="checkbox" name="aAutoCreateCampaign" value="1"<?php /*if ($autoCreateCampaign) ' checked="checked"';*/ ?> />
                                        Auto Create Campaign from this Attack
                                    </label>
								</div>
                                <input class="form-control" type="hidden" name="xml" />
                                <input class="form-control" type="hidden" name="aBackdoor_App" />
                                <input class="form-control" type="hidden" name="aProfile" />
                                <input type="submit" class="btn btn-primary" name="submit" value="Save" disabled="disabled">
                                <input type="button" class="btn btn-primary" value="Cancel" onclick="location.href = 'dagah_home.html'" />
                            </form>
                            <!-- /.table-responsive -->
                        </div>
                        <!-- /.panel-body -->
                    </div>
                    <!-- /.panel -->
                </div>
                <!-- /.col-lg-6 -->
                
            </div>
            </div>
            <!-- /.container-fluid -->
        </div>
        <!-- /#page-wrapper -->

    </div>
    <!-- /#wrapper -->

    <!-- jQuery -->
    <script src="./components/jquery/dist/jquery.min.js"></script>
	<!-- jQuery validation plugin -->
	<script src="./components/jquery/dist/jquery.validate.min.js"></script>
	
    <!-- Bootstrap Core JavaScript -->
    <script src="./components/bootstrap/dist/js/bootstrap.min.js"></script>

    <!-- Metis Menu Plugin JavaScript -->
    <script src="./components/metisMenu/dist/metisMenu.min.js"></script>

    <!-- Custom Theme JavaScript -->
    <script src="./js/sb-admin-2.js"></script>
    <script src="./js/htmlSpecialChars.js"></script>

	<script>		
		
		
		
		$('select#template').change(function (e) {
			
			if (e.target.value) {
				
				// set the template name value to hidden element
				$('#harvester-template-name').val(e.target.value);
				// ignore the URL field on form validation
				$('#webpage_clone').addClass('ignore-validation');
			} else {
				
				// unset the template name value
				$('#harvester-template-name').val('');
				// need to check URL field on form validation
				$('#webpage_clone').removeClass('ignore-validation');
			}
		});
		
	</script>
	  
    <script type="text/javascript">
        $(function () {
            // Get SMS text if SMS delivery is selected
            $('input[name=aDelivery_Method]').change(function () {
                // if SMS selected, require "SMS Text" filled out.
                if ($('input[name=aDelivery_Method]:checked').val() == "sms") {
                    $('.sms').show().children('input').prop('required', true);
                } else {
                    // no SMS, so clear
                    $('.sms').hide().children('input').prop('required', false);
                    $('input[name=aSMS_Text]').val("");
                }
            });
            // Get Message text if Messaging_app delivery is selected
            $('input[name=aDelivery_Method]').change(function () {
                // if Messaging_app selected, require "Message Text" filled out.
                if ($('input[name=aDelivery_Method]:checked').val() == "messagingapp") {
                    $('.messagingapp').show().children('input').prop('required', true);
                    $('.sms').show().children('input').prop('required', true);
                } else {
                    // no Messaging_app, so clear
                    $('.messagingapp').hide().children('input').prop('required', false);
                    $('input[name=aSMS_Text]').val("");
                }
            });

			$("#campaign_form").validate({
				ignore: ".ignore-validation"
			});
			
            // run JS to calculate/save XML before form submission
            $('#campaign_form').submit(function () {
                var type = $('input[name=aAttack_Type]:checked').val();
//				if (type == 'harvester' && $('select#template option:selected').val() != '') {
//					
//					$('#webpage_clone').prop('required', false);
//				} else {
//					console.log(type, $('select#template option:selected').val());
//				}
                var name = $('input[name=campaign]').val();
                var page = $('input[name=aTarget_Page]').val();
                var text = $('input[name=aPhishing_Text]').val();
                var label = $('input[name=aAttack_Label]').val();
                var directory = $('input[name=aAttack_Label]').val();
                //var directory = $('input[name=aFile_Directory]').val();
                var delivery = $('input[name=aDelivery_Method]:checked').val();
                // Copy the aSMS_Text for both SMS and Messaging_Apps
                if ($('input[name=aSMS_Text]').val() != "") {
                    // SMS text
                    var sms = ' smstext="' + $('input[name=aSMS_Text]').val() + '"';
                    var messaging_text = ' messagetext="' + $('input[name=aSMS_Text]').val() + '"';
                } else {
                    var sms = '';
                    var messaging_text = '';
                }
                // Hide the messaing_text if SMS
                if (delivery == "sms") {
                    var messaging_text = '';
                }
                // Hide the sms if Messaging_App
                if (delivery == "messagingapp") {
                    // Messaging App Type
                    var messaging_app = ' app="' + $('input[name=amessaging_app]').val() + '"';
                    var sms = '';
                } else {
                    var messaging_app = '';
                }
                var webpagetext = htmlSpecialChars($('input[name=aWebpage_Text]').val());
                var clonepage = $('input[name=aWebpage_Clone]').val();
				if (type == 'harvester' && $('select#template option:selected').val() != '') {
				
					clonepage = 'clonepage="template" template="' + $('select#template option:selected').val() + '"';
				} else {
					
					clonepage = 'clonepage="' + clonepage + '"';
				}

                switch (type) {
                    case 'basic':
                        var XML = '<attacks><basic page=\"' + page + '\" label=\"' + label + '\" directory=\"' + directory + '\" deliverymethod=\"' + delivery + '"' + sms + messaging_text + messaging_app + ' webpagetext=\"' + webpagetext + '\" /></attacks>';
                        break;
                    case 'harvester':
                        var XML = '<attacks><harvester page=\"' + page + '\" label=\"' + label + '\" directory=\"' + directory + '\" deliverymethod=\"' + delivery + '"' + sms + messaging_text + messaging_app + ' ' + clonepage + '/></attacks>';
                        break;
                    case 'profile':
                         var p_path = <?php echo "\"" . $_SESSION['dagah_dir'] . $_SESSION['profiles_dir'] . "\""; ?> + $('#profile_name').val().replace("C:\\fakepath\\", "")
                         $('input[name=aProfile]').val(p_path)
                         var new_profile = " profile_file=\"" + p_path + "\""
                         var XML = '<attacks><profile page=\"' + page + '\" label=\"' + label + '\" directory=\"' + directory + '\" deliverymethod=\"' + delivery + '"' + sms +   messaging_text + messaging_app + new_profile + ' /></attacks>';
                         break;                        
                    case 'agent':
                        if ($('#android_app').val()) {
                            // android apk
                            var a_path = <?php echo "\"" . $_SESSION['dagah_dir'] . "\""; ?> + "/android_uploads/" + $('#android_app').val().replace("C:\\fakepath\\", "")
                           $('input[name=aBackdoor_App]').val(a_path)
                            var new_backdoor = " backdoorapp=\"" + a_path + "\""
                        } else {
                            var new_backdoor = " backdoor=\"none\" "
                        }
                        var XML = '<attacks><agent page=\"' + page + '\" label=\"' + label + '\" directory=\"' + directory + '\" deliverymethod=\"' + delivery + '"' + sms +  messaging_text + messaging_app + new_backdoor + ' /></attacks>';
                        break;                        
                }
                $('input[name=xml]').val(XML);
            });
			
			initializePage();
        });

        // hide form until radio selection made, then unhide depending
        $('input[name=aAttack_Type]').change(function () {
            $('input[name=submit]').prop('disabled', false);
            $('.all').show();
            switch ($('input[name=aAttack_Type]:checked').val()) {
                case 'basic':
                    $('.basic').show().children('input').prop('required', true)
                    $('.harvester').hide().children('input').prop('required', false)
                    $('.agent').hide().children('input').prop('required', false)
                    $('.profile').hide().children('input').prop('required',false)
                    $('.client').hide().children('input').prop('required', false)
                    break;
                case 'harvester':
                    $('.basic').hide().children('input').prop('required', false)
                    $('.harvester').show().children('input').prop('required', true)
                    $('.agent').hide().children('input').prop('required', false)
                    $('.profile').hide().children('input').prop('required',false)
                    $('.client').hide().children('input').prop('required', false)
                    break;
                case 'agent':
                    $('.basic').hide().children('input').prop('required', false)
                    $('.harvester').hide().children('input').prop('required', false)
                    $('.agent').show().children('input').prop('required', true)
                    $('.profile').hide().children('input').prop('required',false)
                    $('.client').hide().children('input').prop('required', false)
                    break;
                case 'profile':
                    $('.basic').hide().children('input').prop('required', false)
                    $('.harvester').hide().children('input').prop('required', false)
                    $('.agent').hide().children('input').prop('required', false)
                    $('.profile').show().children('input').prop('required',true)
                    $('.client').hide().children('input').prop('required', false)
                    break;
                case 'client':
                    $('.basic').hide().children('input').prop('required', false)
                    $('.harvester').hide().children('input').prop('required', false)
                    $('.agent').hide().children('input').prop('required', false)
                    $('.profile').hide().children('input').prop('required',false)
                    $('.client').show().children('input').prop('required', true)
                    break;
            }
            // remove required on file uploads
            $('input[type=file]').prop('required', false);
        });

        function selectTemplate(val) {
            
            if (val.value) {
            
                $('#sms_text').val(val.value);
            }
        }
		
		function initializePage() {
		
			var aType = "<?= $aAttack_Type ?>";
			if (aType) {
				$('input[name=aAttack_Type][value=' + aType + ']').attr('checked', 'checked');
				$('input[name=aAttack_Type][value=' + aType + ']').trigger('change');
			}
			
			var deliveryType = "<?= $Delivery_Method ?>";
			if (deliveryType) {
				$('input[name=aDelivery_Method][value=' + deliveryType + ']').attr('checked', 'checked');
				$('input[name=aDelivery_Method][value=' + deliveryType + ']').trigger('change');
			}
			
			var amessaging_app = "<?= $messaging_app ?>";
			if (amessaging_app) {
				$('input[name=amessaging_app][value=' + amessaging_app + ']').attr('checked', 'checked');
				$('input[name=amessaging_app][value=' + amessaging_app + ']').trigger('change');
			}
			
			$('select#template').trigger('change');
		}
    </script>

</body>

</html>
