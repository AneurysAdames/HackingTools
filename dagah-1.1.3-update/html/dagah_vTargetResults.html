<!--Create dagah_vCampaignResults.html which, given a campaignrunid, displays all the targets (numbers/userid) that were sent the campaign (from campaign_results).  To do this, the page neesd to open the results file (from DAGAHLOC/SAVEDRUNSDIR/campaignrunlabel/results) and parses it for targets.  For each found target, update the campaign_results table with the "ResultsString" and datetime from the file.  Paint a table showing the datetime, Number, UserID, and results string.  If the campaignrunid is not provided, a table of campaignrunids and campaignrunlabels should be displayed with links to dagah_vCampaignResults.html for each campaignrunid.-->
<?php
require_once './php/db_creds.php';
require_once './php/Dagah/CampaignRunFactory.php';
require_once './php/Dagah/TargetFactory.php';

if (session_status() !== PHP_SESSION_ACTIVE) {
    session_start();
}
if (!isset($_SESSION['userid'])) {
    header('Location:  login.html');
}
$userId = $_SESSION['userid'];
$connection = mysqli_connect($db_hostname, $db_username, $db_password, $db_database);

$number = null;

if (!empty($_GET['number'])) {
	
	$number = $_GET['number'];
    $resultList = TargetFactory::getById($connection, $userId, $number);
    if (empty($resultList)) {
        header('Location:  dagah_error_404.html');
    }
} else {
 
	//$targetAttackedList = TargetFactory::getTotalAttackedList/*getTotalList*/($connection, $userId);//getTotalList
	$targetTotalList = TargetFactory::getTotalWithCampaignsList($userId);

	$targetResponsedList = TargetFactory::getResponsedWithCampaignsList/*getTotalList*/($userId);//getTotalList

	$attackedTargetsList = TargetFactory::getTotalAttackedList($connection, $userId);
	$respondedTargetsList = TargetFactory::getResponsedList($connection, $userId);
	
	$notRespondedNumbersCnt = count($respondedTargetsList) > count($attackedTargetsList)
		? 0
		: count($attackedTargetsList) - count($respondedTargetsList);
	$respondedNumbersCnt = count($respondedTargetsList);
	//_d([$notRespondedNumbersCnt, $respondedNumbersCnt]);
}

?>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>View Target Results | Dagah</title>
    <link href="./components/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet" type="text/css">
    <link href="./components/metisMenu/dist/metisMenu.min.css" rel="stylesheet">
    <link href="./css/Dagah.css" rel="stylesheet">
    <link href="./css/Dagah_custom.css" rel="stylesheet">
    <link href="./components/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>

<body>
<div id="wrapper">
<?php include('dagah_nav.html'); ?>
<div id="page-wrapper">
<div class="container-fluid">
<h2><i class="fa fa-crosshairs fa-fw"></i> View <?= !empty($number) ? $number . ' target' : 'Targets' ?></h2>
<div class="row">
<!--   List View   -->
<?php if (!$number) : ?>
    <div class="col-lg-8">

		<?php if (isset($targetTotalList)) : ?>
        <div class="panel panel-primary">
			<div class="panel-heading">Attacked Targets</div>
            <div class="panel-body">
                <?php if (!empty($_SESSION['page_errors'])) {
                    echo '<div class="alert alert-danger">' . $_SESSION['page_errors'] . '</div>';
                    unset($_SESSION['page_errors']);die;
                } ?>
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                        <tr>
							<th>Name</th>
                            <th>Number</th>
							<th>Phone Group</th>
							<th>Campaigns</th>
                        </tr>
                        </thead>
                        <tbody>
                        <?php foreach ($targetTotalList as $target) : ?>
                            <tr>
								<td>
                                    <?= $target->Name ?>
                                </td>
                                <td>
                                    <a href="dagah_vTargetResults.html?number=<?= htmlspecialchars($target->Number) ?>">
                                        <?= $target->Number ?>
									</a>
                                </td>
								<td>
                                    <?= $target->PhoneGroup ?>
                                </td>
								<td>
                                    <?= $target->CampaignName ?>
                                </td>
                            </tr>
                        <?php endforeach ?>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
		<?php endif; ?>
		
		
		<?php if (isset($targetResponsedList)) : ?>
		<div class="panel panel-primary">
			<div class="panel-heading">Responsed Targets</div>
            <div class="panel-body">
                <?php if (!empty($_SESSION['page_errors'])) {
                    echo '<div class="alert alert-danger">' . $_SESSION['page_errors'] . '</div>';
                    unset($_SESSION['page_errors']);die;
                } ?>
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                        <tr>
							<th>Name</th>
                            <th>Number</th>
							<th>Phone Group</th>
							<th>Campaigns</th>
                        </tr>
                        </thead>
                        <tbody>
                        <?php foreach ($targetResponsedList as $target) : ?>
                            <tr>
								<td>
                                    <?= $target->Name ?>
                                </td>
                                <td>
                                    <a href="dagah_vTargetResults.html?number=<?= htmlspecialchars($target->Number) ?>">
                                        <?= $target->Number ?>
									</a>
                                </td>
								<td>
                                    <?= $target->PhoneGroup ?>
                                </td>
								<td>
                                    <?= $target->CampaignName ?>
                                </td>
                            </tr>
                        <?php endforeach ?>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
		<?php endif; ?>
    </div>

	<div class="col-lg-4">
        <div class="panel panel-primary">
			<div class="panel-heading">Campaigns attacks results statistics</div>
            <div class="panel-body">
                
                <div class="table-responsive">
					<canvas id="myChart" width="25%" height="25%"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!--   Single View   -->
<?php elseif (!empty($resultList) && count($resultList) > 0) : ?>
    <div class="col-lg-12">
        <div class="panel panel-primary">
            <div class="panel-heading">Campaigns</div>
            <div class="panel-body">
                <?php if (!empty($_SESSION['page_errors'])) {
                    echo '<div class="alert alert-danger">' . $_SESSION['page_errors'] . '</div>';
                    unset($_SESSION['page_errors']);
                } ?>
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                        <tr>
                            <th>Campaign Run</th>
                            <th>Run Time</th>
                            <th>Result</th>
                        </tr>
                        </thead>
                        <tbody>
                        <?php foreach ($resultList as $result) : ?>
                            <tr>
                                <td><a href="dagah_vCampaignResults.html?id=<?= $result->campaignRunId ?>">
                                    <?= $result->runDirectory ?></a></td>
                                <td><?= $result->runTime ?></td>
                                <td><?= $result->resultsString ?></td>
                            </tr>
                        <?php endforeach ?>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    </div>
<?php endif ?>
</div>


</div>
</div>
</div>

<script src="./components/jquery/dist/jquery.min.js"></script>
<script src="./components/bootstrap/dist/js/bootstrap.min.js"></script>
<script src="./components/metisMenu/dist/metisMenu.min.js"></script>
<script src="./js/sb-admin-2.js"></script>

<script src="./js/chartjs/Chart.js"></script>
<!--script src="./js/chartjs/regaddi/Chart.js"></script-->
<script type="text/javascript">
	// And for a doughnut chart
	var ctx = document.getElementById('myChart');
	//ctx.canvas = document.getElementById('myChart');
	//Chart.defaults.global.tooltips.enabled = false;
	//Chart.defaults.global.showTooltips = false;
	
	var myDoughnutChart = new Chart(ctx, {
		type: 'doughnut',
		data:  {
			labels: [
				"No response",
				"Responded"
			],
			datasets: [
				{
					data: [<?= $notRespondedNumbersCnt ?>, <?= $respondedNumbersCnt ?>],
					backgroundColor: [
						
						"#FFCE56",
						"#36A2EB",
					],
					hoverBackgroundColor: [
						
						"#FFCE56",
						"#36A2EB",
					]
				}
			]
		},
		options: {
			
			legend: {display: false},
			tooltips: { enabled: false },
			//showTooltips: false,
			hover: false,
			animation: {
				duration: 0,
				onComplete: function () {
					
					//this.showTooltip(this.segments, true);
					
				  var self = this,
					  chartInstance = this.chart,
					  ctx = chartInstance.ctx;

				  ctx.font = '8px Arial';
				  ctx.textAlign = "center";
				  ctx.fillStyle = "#FFFFFF";

				  Chart.helpers.each(self.data.datasets.forEach((dataset, datasetIndex) => {
					  var meta = self.getDatasetMeta(datasetIndex),
						  total = 0, //total values to compute fraction
						  labelxy = [],
						  offset = Math.PI / 2, //start sector from top
						  radius,
						  centerx,
						  centery, 
						  lastend = 0; //prev arc's end line: starting with 0

					  for (var val of dataset.data) { total += val; } 

					  Chart.helpers.each(meta.data.forEach((element, index) => {
						  radius = 0.9 * element._model.outerRadius - element._model.innerRadius;
						  centerx = element._model.x;
						  centery = element._model.y;
						  var thispart = dataset.data[index],
							  arcsector = Math.PI * (2 * thispart / total);
						  if (element.hasValue() && dataset.data[index] > 0) {
							labelxy.push(lastend + arcsector / 2 + Math.PI + offset);
						  }
						  else {
							labelxy.push(-1);
						  }
						  lastend += arcsector;
					  }), self)

					  var lradius = radius * 1.8;
					  ctx.font = Math.round(radius / 5) + 'px Arial';
					  for (var idx in labelxy) {
						
						if (labelxy[idx] === -1) continue;
						var langle = labelxy[idx],
							dx = centerx + lradius * Math.cos(langle),
							dy = centery + lradius * Math.sin(langle),
							val = self.data.labels[idx];
						
						var responded = (self.data.labels[idx] == 'Responded');
						
						
						
						if ( Math.round(dataset.data[idx] / total * 100) < (responded ? 10 : 11)) { 
						
							var border = Math.round(radius * 0.02);
							ctx.fillStyle = "#FFFFFF";
							ctx.fillRect(dx - Math.round(radius * 0.65) - border, dy - Math.round(radius * 0.2) - border, Math.round(radius * 1.3) + 2 * border, Math.round(radius * 0.5) + 2 * border);
							ctx.fillStyle = !responded ? "#FFCE56" : "#36A2EB";
							ctx.fillRect(dx - Math.round(radius * 0.65), dy - Math.round(radius * 0.2), Math.round(radius * 1.3), Math.round(radius * 0.5));
						}
						
						ctx.fillStyle = responded ? "#FFFFFF" : "#000000";
						ctx.fillText(val, dx, dy);
						ctx.fillText("(" + dataset.data[idx] + ")", dx, dy + Math.round(radius * 0.22));
						
						if (responded) {

							var val = Math.round(dataset.data[idx] / total * 100);
							var dx = centerx;
							var dy = centery;
							ctx.font =  Math.round(radius * 0.3) + 'px Arial';
							ctx.textAlign = "center";
							ctx.fillStyle = "#000000";
							ctx.fillText(val + '%', dx + Math.round(radius * 0.05), dy + Math.round(radius * 0.05));
						}	
					  }

				  }), self);
				}
			}
		}
	});
	
	
</script>
	
</body>

</html>
