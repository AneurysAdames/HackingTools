<?php
    $error = false;
    require_once './php/db_creds.php';
    // check for existing session
    session_start();
    if (isset($_SESSION['userid'])) {
        $id=split("=", $_SERVER['QUERY_STRING'])[1];
        $userID=$_SESSION['userid'];
        $connection = mysqli_connect($db_hostname, $db_username, $db_password, $db_database);
        // delete databse entires
        // attacks table
        $stmt = mysqli_stmt_init($connection);
        mysqli_stmt_prepare($stmt, 'DELETE FROM attacks WHERE ID=? AND UserID=?');
        mysqli_stmt_bind_param($stmt,'ii', $id, $userID);
        mysqli_stmt_execute($stmt);
        mysqli_stmt_store_result($stmt);

        // attack attributes table
        mysqli_stmt_prepare($stmt, 'DELETE FROM attack_attributes WHERE AttackID=? AND UserID=?');
        mysqli_stmt_bind_param($stmt,'ii', $id, $userID);
        mysqli_stmt_execute($stmt);
        mysqli_stmt_store_result($stmt);

        // campaigns table
        mysqli_stmt_prepare($stmt, 'DELETE FROM campaigns where ID IN (SELECT CampaignID FROM linkcampaignsattacks WHERE AttackID=?) AND UserID=?');
        mysqli_stmt_bind_param($stmt,'ii', $id, $userID);
        mysqli_stmt_execute($stmt);
        mysqli_stmt_store_result($stmt);
        
        // campaign_runs table
        mysqli_stmt_prepare($stmt, 'DELETE FROM campaign_runs where CampaignID IN (SELECT CampaignID FROM linkcampaignsattacks WHERE AttackID=?) AND UserID=?');
        mysqli_stmt_bind_param($stmt,'ii', $id, $userID);
        mysqli_stmt_execute($stmt);
        mysqli_stmt_store_result($stmt);

        // campaign_results table
        // TO DO

        // linkcampaignphone table
        $stmt = mysqli_stmt_init($connection);
        mysqli_stmt_prepare($stmt, 'DELETE FROM linkcampaignphone WHERE CampaignID IN (SELECT CampaignID FROM linkcampaignsattacks WHERE AttackID=?)');
        mysqli_stmt_bind_param($stmt,'i', $id);
        mysqli_stmt_execute($stmt);
        mysqli_stmt_store_result($stmt);        

        // linkcampaignsattack table DO THIS LAST
        mysqli_stmt_prepare($stmt, 'DELETE FROM linkcampaignsattacks where AttackID=?');
        mysqli_stmt_bind_param($stmt,'i', $id);
        mysqli_stmt_execute($stmt);
        mysqli_stmt_store_result($stmt);

        // save notification
        $Comment = "Attack Deleted " . $id;
        $Type = "campaign";
        $userID = $_SESSION['userid'];
        $stmt_not = mysqli_stmt_init($connection);
        mysqli_stmt_prepare($stmt_not, 'INSERT INTO notifications (Comment, Time, Type, UserID) VALUES (?,(now() - interval 4 hour),?,?)');
        mysqli_stmt_bind_param($stmt_not, 'ssi',$Comment,$Type,$userID);
        mysqli_stmt_execute($stmt_not);
        mysqli_stmt_store_result($stmt_not);

        header('Location: dagah_vAttacks.html');
    } else {
        // take back to login
        header('Location:  login.html');   
    }
?>
<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Dagah</title>

</head>

<body>
</body>

</html>
