<?php
    require_once './php/db_creds.php';
    // check for existing session
    session_start();
    // Set Timezone to UTC
    date_default_timezone_set('UTC');
    if (isset($_SESSION['userid'])) {
        $home_not_userID=$_SESSION['userid'];
        $connection = mysqli_connect($db_hostname, $db_username, $db_password, $db_database);
        if (mysqli_connect_errno()) {
            $message = "Failed to connect to MySQL: " . mysqli_connect_error();
        }
        
        if (isset($_SESSION['message'])) {
            $message = $_SESSION['message'];
            unset($_SESSION['message']);
        } else {
            $message = '';
        }
    
        $stmt_not = mysqli_stmt_init($connection);
        mysqli_stmt_prepare($stmt_not, 'SELECT Comment, Time, Type FROM notifications WHERE UserID=? ORDER BY Time DESC LIMIT 10');
        mysqli_stmt_bind_param($stmt_not, 'i', $home_not_userID);
        mysqli_stmt_execute($stmt_not);
        mysqli_stmt_store_result($stmt_not);
        mysqli_stmt_bind_result($stmt_not, $not_comment, $not_time, $not_type);

        // get attack count
        $home_camp_userID=$_SESSION['userid'];
        $stmt = mysqli_stmt_init($connection);
        mysqli_stmt_prepare($stmt, 'SELECT ID, Label, Created FROM attacks WHERE UserID=? ORDER BY Created DESC');
        mysqli_stmt_bind_param($stmt, 'i', $home_camp_userID);
        mysqli_stmt_execute($stmt);
        mysqli_stmt_store_result($stmt);
        $attack_count=mysqli_stmt_num_rows($stmt);
        
        // get campaign count
        $stmt = mysqli_stmt_init($connection);
        mysqli_stmt_prepare($stmt, 'SELECT * FROM campaigns WHERE UserID=?');
        mysqli_stmt_bind_param($stmt, 'i', $home_camp_userID);
        mysqli_stmt_execute($stmt);
        mysqli_stmt_store_result($stmt);
        $campaign_count=mysqli_stmt_num_rows($stmt);

        // get executed campaign count
        $home_run_userID=$_SESSION['userid'];
        $stmt = mysqli_stmt_init($connection);
        mysqli_stmt_prepare($stmt, 'SELECT * FROM campaign_runs WHERE UserID=?');
        mysqli_stmt_bind_param($stmt, 'i', $home_run_userID);
        mysqli_stmt_execute($stmt);
        mysqli_stmt_store_result($stmt);
        $campaignEx_count=mysqli_stmt_num_rows($stmt);

     // get local versio
        $home_version=$_SESSION['userID'];
        $stmt = mysqli_stmt_init($connection);
        mysqli_stmt_prepare($stmt, 'SELECT * FROM version');
        mysqli_stmt_bind_param($stmt, 'i', $localvers);
        mysqli_stmt_execute($stmt);
        mysqli_stmt_bind_result($stmt, $localvers);
        mysqli_stmt_fetch($stmt);
        mysqli_stmt_store_result($stmt, $localvers);
// echo "<pre>$localvers</pre>";
   //     $version_count=mysqli_stmt_num_rows($stmt);     



        // get phone number count
        $home_phone_userID=$_SESSION['userid'];
        $stmt = mysqli_stmt_init($connection);
        mysqli_stmt_prepare($stmt, 'SELECT * FROM phonebook WHERE UserID=?');
        mysqli_stmt_bind_param($stmt, 'i', $home_phone_userID);
        mysqli_stmt_execute($stmt);
        mysqli_stmt_store_result($stmt);
        $phone_count=mysqli_stmt_num_rows($stmt);


        // check for saved config file
        $sql="SELECT * FROM configuration";
        $config_result=mysqli_query($connection, $sql);
        $config_count=mysqli_num_rows($config_result);
        // if no config files set, warn them!
        $config_warning = "";
        if (($config_count == 0) && ($_SESSION['servAdmin'] == 0)) {
            $config_warning = "<div class='alert alert-danger'>Site Configuration is not set. Please contact your system administrator to have properly configured before use.</div>";
        } else if (($config_count == 0) && ($_SESSION['servAdmin'] == 1)) {
            $config_warning = "<div class='alert alert-danger'>Site Configuration is not set. Please configure before first use.</div>";
        }
        
        // check user last login field
        if ($firstLogin = !empty($_SESSION['first_time_login'])) {
            
            unset($_SESSION['first_time_login']);
        }
    } else {
        // no session data-- send back to login
        header('Location:  login.html');
    }



   require_once './php/rds_creds.php';
    // check for existing session
    session_start();
    // Set Timezone to UTC
    date_default_timezone_set('UTC');
  
 



$rdshost="dagah-cluster.cluster-cy8qrazxqitr.us-east-1.rds.amazonaws.com";
$rdsport="3306";
$rdssocket="";
$rdsuser="dagah";
$rdspassword="ZMQAahL24ng3mKG7fQOO!!!!!!SDJKAS!!!12445";
$rdsdbname="dagahupdate";
$rdsID="";
           

$rdsconnection = mysqli_connect($rdshost, $rdsuser, $rdspassword, $rdsdbname, $rdsport);
  if (mysqli_connect_errno()) {
            $message = "Failed to connect to MySQL: " . mysqli_connect_error();
}
       $rdsID=$_SERVER['rdsuserid'];
        $stmt = mysqli_stmt_init($rdsconnection);
        mysqli_stmt_prepare($stmt, 'SELECT * FROM version');
        mysqli_stmt_bind_param($stmt, 'i', $rdsID);
        mysqli_stmt_execute($stmt);
    mysqli_stmt_bind_result($stmt, $rdsvers1);
       
    mysqli_stmt_fetch($stmt); 
    mysqli_stmt_store_result($stmt);
//      echo "<pre>$rdsvers1</pre>";
        if (($rdsvers1 !== $localvers)) {
         $version_warning = "<div class='alert alert-danger'><b><a href='dagah_update.html'>Dagah Software Update Available!</b></a></div>";
       } else if (($rdsvers1 == $localvers)) {
           $version_warning = "";
      }
 

?>
    <!DOCTYPE html>
    <html lang="en">

    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="description" content="">
        <meta name="author" content="">
        <title>Dagah</title>
        <!-- Bootstrap Core CSS -->
        <link href="./components/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet" type="text/css">
        <!-- MetisMenu CSS -->
        <link href="./components/metisMenu/dist/metisMenu.min.css" rel="stylesheet">
        <link href="./css/timeline.css" rel="stylesheet" />
        <!-- Custom CSS -->
        <link href="./css/Dagah.css" rel="stylesheet">
        <link href="./css/Dagah_custom.css" rel="stylesheet">
        <!-- Custom Fonts -->
        <link href="./components/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">
        <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
    </head>
    <body<?php if ($firstLogin) : ?> onload="startIntro()"
        <?php endif; ?>>
        <div id="wrapper">
            <!-- Navigation -->
            <?php include('dagah_nav.html'); ?>
            <!-- Page Content -->
            <div id="page-wrapper">
                <div class="container-fluid">
                    <?php echo $message ?>
                    <div class="row">
                        <div class="col-lg-12">
                            <?php echo $config_warning ?>
                            <?php echo $version_warning ?>
                            <!--                        <h1 class="page-header">Welcome!</h1> -->
                        </div>
                        <!-- /.col-lg-12 -->
                    </div>
                    <!-- /.row -->
                    <div class="row">
                        <div class="col-lg-3 col-md-6">
                            <div class="panel panel-red">
                                <div class="panel-heading">
                                    <div class="row">
                                        <div class="col-xs-3">
                                            <i class="fa fa-bolt fa-4x"></i>
                                        </div>
                                        <div class="col-xs-9 text-right">
                                            <div class="huge">
                                                <?php echo $attack_count ?>
                                            </div>
                                            <div>Attacks</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="panel-footer">
                                    <a class="pull-left intro-step3" href="dagah_dAttacks.html">
                                        <i class="fa fa-plus-circle"></i>
                                        <span>Add New</span>
                                    </a>
                                    <a href="dagah_vAttacks.html">
                                        <span class="pull-right">View</span>
                                    </a>
                                    <div class="clearfix"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <div class="panel panel-primary">
                                <div class="panel-heading">
                                    <div class="row">
                                        <div class="col-xs-3">
                                            <div class="campaigns-icon-div">
                                                <i class="fa fa-bolt fa-2x"></i><i class="fa fa-bolt fa-align-left fa-3x"></i><i class="fa fa-bolt fa-align-left fa-2x"></i>
                                            </div>
                                        </div>
                                        <div class="col-xs-9 text-right">
                                            <div class="huge">
                                                <?php echo $campaign_count ?>
                                            </div>
                                            <div>Campaigns</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="panel-footer">
                                    <a class="pull-left intro-step3" href="dagah_dCampaigns.html">
                                        <i class="fa fa-plus-circle"></i>
                                        <span>Add New</span>
                                    </a>
                                    <a href="dagah_vCampaigns.html">
                                        <span class="pull-right">View</span>
                                    </a>
                                    <div class="clearfix"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <div class="panel panel-yellow">
                                <div class="panel-heading">
                                    <div class="row">
                                        <div class="col-xs-3">
                                            <i class="fa fa-crosshairs fa-4x"></i>
                                        </div>
                                        <div class="col-xs-9 text-right">
                                            <div class="huge">
                                                <?php echo $phone_count ?>
                                            </div>
                                            <div>Targets</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="panel-footer">
                                    <a class="pull-left intro-step4" href="dagah_vPhone.html">
                                        <i class="col-xs-9 text-right"></i>
                                        <span>Add New</span>
                                    </a>
                                    <a href="dagah_vPhone.html">
                                        <span class="pull-right">View</span>
                                    </a>
                                    <div class="clearfix"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <div class="panel panel-green">
                                <div class="panel-heading">
                                    <div class="row">
                                        <div class="col-xs-3">
                                            <i class="fa fa-check-circle fa-4x"></i>
                                        </div>
                                        <div class="col-xs-9 text-right">
                                            <div class="huge">
                                                <?php echo $campaignEx_count ?>
                                            </div>
                                            <div>Executed Campaigns</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="panel-footer">
                                    <a href="dagah_rCampaigns.html">
                                        <span class="pull-right">View</span>
                                    </a>
                                    <div class="clearfix"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-lg-4">
                            <div class="panel panel-default">
                                <div class="panel-heading">
                                    <i class="fa fa-bell fa-fw"></i> Notifications Panel
                                </div>
                                <!-- /.panel-heading -->
                                <div class="panel-body">
                                    <div class="list-group">
                                        <?php

                                    while(mysqli_stmt_fetch($stmt_not)) {
                                        $date = date_create($not_time);
                                        switch ($not_type) {
                                            case "task":
                                                $icon = "fa fa-tasks";
                                                break;
                                            case "account":
                                                $icon = "fa fa-user";
                                                break;
                                            case "phone":
                                                $icon = "fa fa-crosshairs";
                                                break;
                                            case "campaign":
                                                $icon = "fa fa-empire";
                                                break;
                                            case "login":
                                                $icon = "glyphicon glyphicon-log-in";
                                                break;
                                            case "logout":
                                                $icon = "glyphicon glyphicon-log-out";
                                                break;
                                            case "settings":
                                                $icon = "fa fa-gear";
                                                break;
                                        }
                                        $i = "<i class='" . $icon . " fa-fw'></i> " . $not_comment;
                                ?>
                                            <a href="#" class="list-group-item">
                                                <?php echo $i ?>
                                                <span class="pull-right text-muted small"><em><?php echo date_format($date, 'M d H:i'); ?></em>
                                    </span>
                                            </a>
                                            <?php
                                    }
                                ?>
                                    </div>
                                    <!-- /.list-group -->
                                    <a href="dagah_alerts.html" class="btn btn-default btn-block">View All Alerts</a>
                                </div>
                                <!-- /.panel-body -->
                            </div>
                        </div>
                        <!-- /.col-lg-4 -->
                        <div class="col-lg-8">
                            <div class="panel panel-default">
                                <div class="panel-heading">
                                    <i class="fa fa-clock-o fa-fw"></i> Mobile Device Penetration Testing Workflow
                                </div>
                                <!-- /.panel-heading -->
                                <div class="panel-body">
                                    <ul class="timeline">
                                        <li class="timeline-inverted">
                                            <div class="timeline-badge warning"><i class="fa fa-gears"></i>
                                            </div>
                                            <div class="timeline-panel">
                                                <div class="timeline-heading">
                                                    <h4 class="timeline-title">Create Attack(s)</h4>
                                                </div>
                                                <div class="timeline-body">
                                                    <p>User first designs one (or more) "Attacks". These attacks will be the source for the next step of designing a Campaign.
                                                    </p>
                                                </div>
                                            </div>
                                        </li>
                                        <li>
                                            <div class="timeline-badge"><i class="fa fa-gears"></i>
                                            </div>
                                            <div class="timeline-panel">
                                                <div class="timeline-heading">
                                                    <h4 class="timeline-title">Create Campaign</h4>
                                                </div>
                                                <div class="timeline-body">
                                                    <p>User designs a "Campaign". This is the type of attack(s) that will be launched along with it's individual parameters.
                                                    </p>
                                                </div>
                                            </div>
                                        </li>
                                        <li class="timeline-inverted">
                                            <div class="timeline-badge danger"><i class="fa fa-crosshairs"></i>
                                            </div>
                                            <div class="timeline-panel">
                                                <div class="timeline-heading">
                                                    <h4 class="timeline-title">Create Target List</h4>
                                                </div>
                                                <div class="timeline-body">
                                                    <p>Targets are specified mobile phone numbers. These numbers are grouped into Phone Books which are later defined to run Campaigns against.</p>
                                                </div>
                                            </div>
                                        </li>
                                        <li>
                                            <div class="timeline-badge info"><i class="fa fa-bolt"></i><i class="fa fa-bolt"></i><i class="fa fa-bolt"></i>
                                            </div>
                                            <div class="timeline-panel">
                                                <div class="timeline-heading">
                                                    <h4 class="timeline-title">Run Campaign</h4>
                                                </div>
                                                <div class="timeline-body">
                                                    <p>This stage is where the (a) Campaign, (b) Target List, and (c) Run-Time are defined and executed within the system.</p>
                                                </div>
                                            </div>
                                        </li>
                                        <li class="timeline-inverted">
                                            <div class="timeline-badge success"><i class="fa fa-bar-chart"></i>
                                            </div>
                                            <div class="timeline-panel">
                                                <div class="timeline-heading">
                                                    <h4 class="timeline-title">Results</h4>
                                                </div>
                                                <div class="timeline-body">
                                                    <p>This is where the results of the Campaign can be examined and analyzed</p>
                                                </div>
                                            </div>
                                        </li>
                                    </ul>
                                </div>
                                <!-- /.panel-body -->
                            </div>
                        </div>
                    </div>
                    <!-- /.row -->
                </div>
                <!-- /.container-fluid -->
            </div>
            <!-- /#page-wrapper -->
        </div>
        <!-- /#wrapper -->
        <!-- jQuery -->
        <script src="./components/jquery/dist/jquery.min.js"></script>
        <!-- Bootstrap Core JavaScript -->
        <script src="./components/bootstrap/dist/js/bootstrap.min.js"></script>
        <!-- Metis Menu Plugin JavaScript -->
        <script src="./components/metisMenu/dist/metisMenu.min.js"></script>
        <!-- Custom Theme JavaScript -->
        <script src="./js/sb-admin-2.js"></script>
        </body>
        <script type="text/javascript" src="./js/intro/intro.js"></script>
        <link href="./js/intro/introjs.css" rel="stylesheet">
        <link href="./js/intro/themes/introjs-flattener.css" rel="stylesheet">
        <style>
        .helperNumberLayerTargetTopRight {
            top: 50px;
        }
        
        .helperNumberLayerTargetLeft {
            left: 5px;
        }
        
        .introjs-disabled,
        .introjs-disabled:hover,
        .introjs-disabled:focus {
            color: #9a9a9a;
            border-color: #d4d4d4;
            box-shadow: none;
            cursor: default;
            background-color: #f4f4f4;
            background-image: none;
            text-decoration: none;
        }
        </style>
        <script type="text/javascript">
        function startIntro() {

            var intro = introJs();
            intro.setOptions({
                steps: [{
                    element: '.intro-step1',
                    intro: '<div class="timeline-heading">' + '<h4 class="timeline-title">Set the Configuration</h4>' + '</div>' + '<div class="timeline-body">' + '<p>Set the main site parameters like file location directories, attacks and android agent configurations etc.' + '</p>' + '</div>',
                    position: "bottom",
                    tooltipClass: 'stepNumberBottom'
                }, {
                    element: '.intro-step2',
                    intro: '<div class="timeline-heading">' + '<h4 class="timeline-title">Create Attack(s)</h4>' + '</div>' + '<div class="timeline-body">' + '<p>Design one (or more) "Attacks" first. These attacks will be the source for the next step of designing a Campaign.' + '</p>' + '</div>',
                    position: 'right',
                    tooltipClass: 'stepNumberTopAligned'
                }, {
                    element: '.intro-step3',
                    intro: '<div class="timeline-heading">' + '<h4 class="timeline-title">Create Campaign</h4>' + '</div>' + '<div class="timeline-body">' + '<p>Design a "Campaign". This is the type of attack(s) that will be launched along with it\'s individual parameters.' + '</p>' + '</div>',
                    position: 'bottom'
                }, {
                    element: '.intro-step4',
                    intro: '<div class="timeline-heading">' + '<h4 class="timeline-title">Create Target List</h4>' + '</div>' + '<div class="timeline-body">' + '<p>Targets are specified mobile phone numbers. These numbers are grouped into Phone Books which are later defined to run Campaigns against.' + '</p>' + '</div>',
                    position: 'bottom'
                }, {
                    element: '.intro-step5',
                    intro: '<div class="timeline-heading">' + '<h4 class="timeline-title">Run Campaign</h4>' + '</div>' + '<div class="timeline-body">' + '<p>This stage is where the (a) Campaign, (b) Target List, and (c) Run-Time are defined and executed within the system.' + '</p>' + '</div>',
                    position: 'right',
                    tooltipClass: 'stepNumberTopAligned'
                }, {
                    element: '.intro-step6',
                    intro: '<div class="timeline-heading">' + '<h4 class="timeline-title">Results</h4>' + '</div>' + '<div class="timeline-body">' + '<p>This is where the results of the Campaign can be examined and analyzed' + '</p>' + '</div>',
                    position: 'right',
                    tooltipClass: 'stepNumberTopAligned'
                }]
            });

            intro.onafterchange(function(el) {


                if ($(el).hasClass('intro-step1')) {


                    $('.introjs-helperNumberLayer').addClass('helperNumberLayerTargetTopRight');
                    $('.introjs-helperNumberLayer').removeClass('helperNumberLayerTargetLeft');

                } else if ($(el).hasClass('intro-step2') || $(el).hasClass('intro-step5') || $(el).hasClass('intro-step6')) {

                    //console.log('BEFORE: ', $('.introjs-helperNumberLayer'), $('.introjs-helperNumberLayer').position());
                    $('.introjs-helperNumberLayer').addClass('helperNumberLayerTargetLeft');
                    $('.introjs-helperNumberLayer').removeClass('helperNumberLayerTargetTopRight');

                } else {

                    $('.introjs-helperNumberLayer').removeClass('helperNumberLayerTargetLeft');
                    $('.introjs-helperNumberLayer').removeClass('helperNumberLayerTargetTopRight');
                }
            });

            intro.start();
        }
        </script>
        <div class="footer">
            <div class="container">
                <center> <span> <a class="shevirahLogo center-block" src="images/shevirahName.png">  <a class="navbar-footer"><a href=http://www.shevirah.com target=_blank>Shevirah Inc. |   <a href=http://www.shevirah.com/downloads target=_blank>Updates    |<a href="mailto:"support@shevirah.com target=_blank>   Support </span></a>
                </center>
            </div>
        </div>

    </html>
