<?php

require_once './php/db_creds.php';
require_once './php/Dagah/CampaignRunFactory.php';
require_once './php/Dagah/TargetFactory.php';

if (session_status() !== PHP_SESSION_ACTIVE) {
    session_start();
}
if (!isset($_SESSION['userid'])) {
    header('Location:  login.html');
}
$userId = $_SESSION['userid'];
$connection = mysqli_connect($db_hostname, $db_username, $db_password, $db_database);

if (!empty($_GET['id']) && is_int((int) $_GET['id'])) {
	
	if (isset($_GET['showTargets']) && $_GET['showTargets']) {

		$campaignRunId = (int) $_GET['id'];
		$campaignRun = CampaignRunFactory::getById($connection, $userId, $campaignRunId);
		$campaignId = $campaignRun->campaignId;

		if (empty($campaignRun)) {
			header('Location:  dagah_error_404.html');
		}
		$resultsRunsList = TargetFactory::getForCampaign($connection, $campaignRun);
	}
} else {
    
    $campaignRunsList = CampaignRunFactory::getList($connection, $userId, ['harvester']);
}
?>

<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Reports</title>

    <!-- Bootstrap Core CSS -->
    <link href="./components/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet" type="text/css"n

    <!-- MetisMenu CSS -->
    <link href="./components/metisMenu/dist/metisMenu.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link href="./css/Dagah.css" rel="stylesheet">
    <link href="./css/Dagah_custom.css" rel="stylesheet">

    <!-- Custom Fonts -->
    <link href="./components/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

</head>

<body>

<div id="wrapper">

<!-- Navigation -->
<?php include('dagah_nav.html'); ?>
		
<!-- Page Content -->
<div id="page-wrapper">
<div class="container-fluid">
<h2><i class="fa fa-crosshairs fa-fw"></i> View <?= !empty($campaignRun) ? ('"' . $campaignRun->runDirectory . '" ') : '' ?>
	Harvester<?= !empty($resultsRunsList) ? ' Targets' : '' ?> Results</h2>
<div class="row">
<!--   List View   -->
<?php if (isset($campaignRunsList)) : ?>
    <div class="col-lg-12">
        <div class="panel panel-default">
            <div class="panel-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Label</th>
                                <th>Type</th>
                                <th>Phone Group</th>
                                <th>Run Time</th>
                            </tr>
                        </thead>
                        <tbody>
                        <?php foreach ($campaignRunsList as $run) : ?>
                            <tr>
                                <td><?= $run->id ?></td>
                                <td><a href="dagah_HarvesterReports.html?id=<?= $run->id ?>&showTargets=true"><?= $run->runDirectory ?></a></td>
                                <td><?= $run->attackType ?></td>
                                <td><?= $run->phoneGroup ?></td>
                                <td><?= $run->runTime ?></td>
                            </tr>
                        <?php endforeach ?>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

<!-- Targets View   -->
<?php elseif ($resultsRunsList) : ?>
	<div class="col-lg-12">
        <div class="panel panel-primary">
            <div class="panel-heading">Targets</div>
            <div class="panel-body">
            <?php if (!empty($_SESSION['page_errors'])) {
                echo '<div class="alert alert-danger">' . $_SESSION['page_errors'] . '</div>';
                unset($_SESSION['page_errors']);
            } else { ?>
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th style="width: 150px;">Run Time</th>
                                <th style="width: 150px;">Number</th>
                                <th style="width: 150px;">User ID</th>
                                <th>Result</th>
                            </tr>
                        </thead>
                        <tbody>
                        <?php foreach ($resultsRunsList as $target) : ?>
                            <tr>
                                <td><?= $target->runTime ?></td>
                                <td><?= $target->number ?></td>
                                <td><?= $target->userId ?></td>
                                <td><?= $target->resultsString ?></td>
                            </tr>
                        <?php endforeach ?>
                        </tbody>
                    </table>
                </div>
                <?php } ?>
            </div>
        </div>
    </div>
<?php endif ?>

</div>
<!-- /.container-fluid -->
</div>
<!-- /#page-wrapper -->

</div>
<!-- /#wrapper -->


<!-- jQuery -->
<script src="./components/jquery/dist/jquery.min.js"></script>

<!-- Bootstrap Core JavaScript -->
<script src="./components/bootstrap/dist/js/bootstrap.min.js"></script>

<!-- Metis Menu Plugin JavaScript -->
<script src="./components/metisMenu/dist/metisMenu.min.js"></script>

<!-- Custom Theme JavaScript -->
<script src="./js/sb-admin-2.js"></script>

</body>

</html>